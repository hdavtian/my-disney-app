# Java 21 Upgrade Notes

**Date:** November 19, 2025  
**Upgraded From:** Java 17  
**Upgraded To:** Java 21 (LTS)

---

## Reason for Upgrade

- **Lombok Compatibility**: Lombok 1.18.34+ requires Java 21 for full compatibility
- **LTS Support**: Java 21 is the latest Long-Term Support release
- **Modern Features**: Access to Java 18-21 features (pattern matching, virtual threads, etc.)

---

## Changes Made

### 1. Maven Configuration (pom.xml)

```xml
<properties>
    <java.version>21</java.version>  <!-- Changed from 17 -->
</properties>

<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <version>1.18.34</version>  <!-- Upgraded from 1.18.32 -->
    <scope>provided</scope>
</dependency>
```

### 2. Docker Configuration (Dockerfile)

**Builder Stage:**

```dockerfile
FROM eclipse-temurin:21-jdk AS builder  # Changed from 17-jdk
```

**Runtime Stage:**

```dockerfile
FROM eclipse-temurin:21-jre  # Changed from 17-jre
```

### 3. Documentation Updates

- ‚úÖ README.md: Java badge, prerequisites, tech stack
- ‚úÖ backend/README.md: Prerequisites section
- ‚úÖ All references to "Java 17" updated to "Java 21"

---

## Development Environment Setup

### System Requirements

**Windows 11 ARM64:**

- Azul Zulu JDK 21.0.9 (ARM64 build)
- JAVA_HOME: `C:\java\zulu21.46.19-ca-jdk21.0.9-win_aarch64`

### IntelliJ IDEA Configuration

1. **Project Structure** (Ctrl+Alt+Shift+S):

   - Project SDK: Java 21
   - Project Language Level: 21 - Pattern matching for switch

2. **Settings** > **Build, Execution, Deployment** > **Compiler**:

   - Enable annotation processing ‚úÖ
   - Obtain processors from project classpath ‚úÖ

3. **Maven Settings**:
   - Maven JRE: Use Project SDK (Java 21)

### VS Code Configuration

**Important:** VS Code caches environment variables on launch. After changing JAVA_HOME:

- Close VS Code completely
- Launch from Windows Terminal: `code C:\sites\my-disney-app`
- Or restart Windows for a complete environment refresh

---

## Verification Steps

### 1. Check Java Version

**Windows Terminal (PowerShell):**

```powershell
mvn --version
# Should show: Java version: 21.0.9, vendor: Azul Systems, Inc.
```

**IntelliJ Terminal:**

```bash
java -version
# Should show: openjdk version "21.0.9"
```

### 2. Maven Compilation

```bash
mvn clean compile
```

Expected output:

- No Lombok annotation errors
- No "cannot find symbol" errors for getters/setters
- Successful BUILD

### 3. Spring Boot Startup

```bash
mvn spring-boot:run -Dspring-boot.run.profiles=local
```

Expected:

- Application starts successfully on port 8080
- Lombok-generated methods work correctly
- @Slf4j logging works

---

## Lombok Integration Status

### Completed Migrations

**Models (7 files):**

- ‚úÖ Movie.java - @Getter @Setter @NoArgsConstructor
- ‚úÖ Character.java - @Getter @Setter @NoArgsConstructor
- ‚úÖ DisneyParkAttraction.java - @Getter @Setter @NoArgsConstructor
- ‚úÖ DisneyPark.java - @Getter @Setter @NoArgsConstructor
- ‚úÖ HeroMovieCarousel.java - @Getter @Setter @NoArgsConstructor
- ‚úÖ CarouselItemDto.java - @Data @NoArgsConstructor @AllArgsConstructor
- ‚úÖ ExcludeCharacterRequest.java - @Data

**Controllers (3 files):**

- ‚úÖ MovieController - @Slf4j added
- ‚úÖ CharacterController - @Slf4j added
- ‚úÖ DisneyParkAttractionController - @Slf4j added

**Code Reduction:**

- ~800 lines of boilerplate removed from models
- Getters, setters, constructors auto-generated by Lombok

---

## Java 21 Features Available

### Pattern Matching for Switch

```java
// Now available in Java 21
String formatted = switch (obj) {
    case Integer i -> String.format("int %d", i);
    case Long l    -> String.format("long %d", l);
    case Double d  -> String.format("double %f", d);
    case String s  -> String.format("String %s", s);
    default        -> obj.toString();
};
```

### Virtual Threads (Preview)

```java
// Lightweight threads for high concurrency
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    executor.submit(() -> log.info("Running in virtual thread"));
}
```

### Record Patterns

```java
// Enhanced pattern matching with records
if (obj instanceof Point(int x, int y)) {
    log.info("Point at: {}, {}", x, y);
}
```

**Note:** Use these features judiciously - consider team familiarity and backward compatibility.

---

## Troubleshooting

### Issue: "cannot find symbol: method setId(long)"

**Cause:** Lombok annotations not being processed

**Solution:**

1. Verify Lombok plugin installed in IntelliJ
2. Enable annotation processing in IntelliJ settings
3. Rebuild project: Build > Rebuild Project
4. Check Java version matches project config (21)

### Issue: VS Code Shows Wrong Java Version

**Cause:** VS Code caches environment variables on startup

**Solution:**

```powershell
# Close VS Code completely
# Launch from terminal with correct environment
code C:\sites\my-disney-app
```

### Issue: Maven Using Wrong Java Version

**Cause:** PATH or JAVA_HOME pointing to wrong JDK

**Solution:**

```powershell
# Check system variable
$env:JAVA_HOME
# Should be: C:\java\zulu21.46.19-ca-jdk21.0.9-win_aarch64

# Update if needed (System Properties > Environment Variables)
# Restart terminal
```

---

## Rollback Plan (If Needed)

If Java 21 causes issues:

1. **Revert pom.xml:**

   ```xml
   <java.version>17</java.version>
   ```

2. **Revert Dockerfile:**

   ```dockerfile
   FROM eclipse-temurin:17-jdk AS builder
   FROM eclipse-temurin:17-jre
   ```

3. **Downgrade Lombok:**

   ```xml
   <artifactId>lombok</artifactId>
   <version>1.18.32</version>
   ```

4. **Rebuild:**
   ```bash
   mvn clean install
   ```

---

## Next Steps

1. ‚úÖ Java 21 upgrade complete
2. ‚úÖ Lombok models migrated
3. üîÑ Test batch endpoints with cURL
4. ‚è≥ Continue with frontend batch API implementation
5. ‚è≥ Complete Lombok service/controller migrations

---

## References

- [Java 21 Release Notes](https://openjdk.org/projects/jdk/21/)
- [Lombok Java 21 Compatibility](https://projectlombok.org/changelog)
- [Spring Boot 3.3 Java 21 Support](https://spring.io/blog/2024/05/23/spring-boot-3-3-0-available-now)
